name: Validate Xcode DerivedData hash

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - "*"
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1" # Weekly on Monday at 06:00 UTC

permissions:
  contents: read

jobs:
  validate-hash:
    name: Validate hash against xcodebuild
    runs-on:
      - nscloud-macos-tahoe-arm64-12x28
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Validate Xcode DerivedData hash
        env:
          NSC_TEST_XCODE_HASH: "1"
        run: go test -v -run TestXcodeDerivedDataHash_Integration ./internal/cache/mode/
