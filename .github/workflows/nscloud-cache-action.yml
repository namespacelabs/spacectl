# Tests the nscloud-cache-action against all cache modes using the current spacectl binary.
# This ensures changes to spacectl don't break any cache mode integrations.

name: Cache action

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - "*"
  merge_group:
    types: [checks_requested]

jobs:
  modes:
    uses: namespacelabs/nscloud-cache-action/.github/workflows/modes-reusable.yaml@4d61c33d0b4333a518e975a0c4de7633d28713bb
    with:
      spacectl-source-ref: ${{ github.event.pull_request.head.sha || github.sha }}

  # Single check for branch protection after all mode tests complete
  modes-ok:
    needs: modes
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check mode tests passed
        run: |
          if [[ "${{ needs.modes.result }}" != "success" ]]; then
            echo "Mode tests failed with result: ${{ needs.modes.result }}"
            exit 1
          fi
          echo "All mode tests passed"
