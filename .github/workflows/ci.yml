name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - "*"
  merge_group:
    types: [checks_requested]

jobs:
  go:
    runs-on:
      - nscloud-ubuntu-22.04-amd64-4x16-with-cache
      - nscloud-cache-size-20gb
      - nscloud-cache-tag-space
    steps:
      - uses: actions/checkout@v6

      - name: Set up Nix cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          path: /nix

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            system-features = kvm nixos-test

      - name: Switch into Nix Shell
        uses: lukas-mertens/switch-into-nix-shell@ce1f85f07ceba523ece60c73eb2b18d1fa5503f5
        with:
          install_nix: false

      - name: Set up cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: |
            go
            golangci-lint

      - name: Check modules
        run: go mod tidy --diff

      - name: Check generated
        run: |
          go generate -x ./...
          git add . && git diff --staged --exit-code

      - name: Check tests
        run: go test -race ./...

      - name: Check linter
        run: |
          golangci-lint run ./...

  space-e2e:
    runs-on:
      - nscloud-ubuntu-22.04-amd64-4x16-with-cache
      - nscloud-cache-size-20gb
      - nscloud-cache-tag-space
    steps:
      - uses: actions/checkout@v6

      - name: Set up Nix cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          path: /nix

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            system-features = kvm nixos-test

      - name: Switch into Nix Shell
        uses: lukas-mertens/switch-into-nix-shell@ce1f85f07ceba523ece60c73eb2b18d1fa5503f5
        with:
          install_nix: false

      - name: Setup cache with space binary
        run: |
          go run . cache mount \
            --dry_run=false \
            --mode=go

      - name: Force cache
        run: go mod download
